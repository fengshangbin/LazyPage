var readyDom = require('./documentReady.js');
var ajax = require('./ajax.js');

var pageStore = {};
var domain;
var publicPathLen = 0;
var reg = null;
var defaultElement;
function initHref(){
	//console.log(publicPath);
	defaultElement = document.querySelector(".lazypage.in");
	var targetElement;
	var targetID = LazyPage.pathParams && LazyPage.pathParams[LazyPage.pathParams.length-1];
	if(targetID==null || targetID=="")
		targetElement = defaultElement;
	else{
		targetElement = document.getElementById(targetID);
		if(targetElement==null) targetElement = defaultElement;
	}
	if(targetElement==null) return;
	domain = getRootPath(location.href);
	if(LazyPage.pathReg !=null){
		reg = new RegExp(LazyPage.pathReg.substring(1), "i");
		var publicPath = location.pathname.replace(reg, "");
		publicPathLen = publicPath.length;
	}
	
	/*pageStore[location.pathname] = [targetElement, LazyPage.pathParams];
	if(targetElement.classList.contains("out"))showPage(location.pathname);
	window.history.replaceState(LazyPage.pathParams, '', location.href);*/
	storePage(location.pathname, location.href, targetElement, LazyPage.pathParams, LazyPage.pathReg);
	//if(targetElement.classList.contains("out"))
	showPage(location.pathname);
	document.addEventListener("click", function(event){
		var target = event.target;
		if (!target) return;
		if (target.tagName.toLowerCase() != "a" && !(target = target.getParentElementByTag("a"))) {
			return;
		}
		var href = target.href;
		//console.log("href: "+href);
		if (/^javascript/.test(href)) {
			return;
		}
		if(domain!=null) href = href.replace(new RegExp(domain, "i"), "");
		if (/^http/i.test(href)){
			return;
		}
		event.preventDefault();
		goto(href);
	});
	window.onpopstate = function(event) {
		/*LazyPage.pathParams = event.state;
		console.log("oppopstate: "+event.state);
		LazyPage.checkBlocks();*/
		var hrefPath = location.pathname;
		LazyPage.pathReg = event.state;
		//pageStore[hrefPathName] = event.state;
		if(pageStore[hrefPath]!=null){
			showPage(hrefPath);
		}else{
			goto(location.href);
		}
	}
}
function goto(href, container){
	href = getRealUrl(href);
	//if(getRealUrl(href) == location.href)return;
	var hrefPath = getHrefPath(href);
	if(pageStore[hrefPath] != null){
		storePage(hrefPath, href, null, null, pageStore[hrefPath].pathReg);
		showPage(hrefPath);
		//window.history.pushState(pageStore[hrefPathName][1], '', href);
		return;
	}else if(LazyPage.pathReg != null){
		var hrefPathName = hrefPath.substring(publicPathLen);
		//console.log(hrefPath);
		var reg = new RegExp(LazyPage.pathReg, "i");
		if(reg.test(hrefPathName)){
			let group = reg.exec(hrefPathName);
			if(group.length>1){
				var pathParams = group.slice(1,group.lengths);
				var targetPageId = pathParams[pathParams.length-1];
				var pageElement;
				if(targetPageId==null || targetPageId=="")
					pageElement = defaultElement;
				else{
					pageElement = document.getElementById(targetPageId);
					if(pageElement!=null) pageElement = defaultElement;
				}
				if(pageElement!=null){
					storePage(hrefPath, href, pageElement, pathParams, LazyPage.pathReg);
					showPage(hrefPath);
					//pageStore[hrefPath] = [targetElement, LazyPage.pathParams];
					//window.history.pushState(LazyPage.pathParams, '', href);
					return;
				}
			}
		}
	}
	ajax({
		url: href,
		header: {"lazypageajax":true},
		dataType: "json",
		success:function(msg){
			//console.log(msg);
			
		},
		error:function(e){ 
			console.log("error",e);
		}
	});
}
function storePage(hrefPath, href, pageElement, pathParams, pathReg){
	if(location.href == getRealUrl(href)){
		window.history.replaceState(pathReg, null, href);
	}else{
		window.history.pushState(pathReg, null, href);
	}
	if(pageStore[hrefPath] == null){
		var obj = {
			pageElement: pageElement,
			pathParams: pathParams
			//pathReg: pathReg
		}
		pageStore[hrefPath] = obj;
	}
	//console.log(pageStore);
}
function showPage(hrefPath){
	var target = pageStore[hrefPath];
	var inPage = target.pageElement;
	LazyPage.pathParams = target.pathParams;
	//LazyPage.pathReg = target.pathReg;
	var parent = inPage.parentNode;
	var outPage = parent.querySelector(".lazypage.in");
	inPage.classList.remove("out");
	inPage.classList.add("in");
	if(outPage!=inPage && outPage!=null){
		outPage.classList.add("out");
		outPage.classList.remove("in");
	}
	//console.log(inPage, outPage);
}
function getRootPath(path){
	var regex = "^((https|http|ftp|rtsp|mms)?://[^/]*)";
	var pattern = new RegExp(regex, "i");
	var m = pattern.exec(path);
	if(m.length>0){
		return m[1];
	}
	return null;
}
function getRealUrl(url){
	if(checkUrl(url))return url;
	else{
		var regex = "("+domain+"/?)";
		var pattern = new RegExp(regex, "g");
		var path = location.pathname.replace(pattern, "");
		if(path.endsWith("/"))path+="end";
		var paths = path.split("/");
		paths.pop();
		if(url.startsWith("/")){
			return domain+url;
		}else if(url.startsWith("../")){
			var count = 0;
			while(url.startsWith("../")){
				url = url.substring(3);
				count++;
			}
			var pathBuffer = "/";
			for(var i=0; i<paths.length-count; i++){
				pathBuffer += paths[i];
			}
			if(pathBuffer.length>1)pathBuffer+=("/");
			return domain+pathBuffer+url;
		}else{
			url = url.replace(/\.\//g, "");
			var pathStr = paths.join("/");
			if(pathStr.length>0)pathStr+="/";
			return domain+"/"+pathStr+url;
		}
	}
}
function checkUrl(url){
	var regex = "^((https|http|ftp|rtsp|mms)?://)(.*?)";
	var pattern = new RegExp(regex, "i");
	return pattern.test(url);
}
function getHrefPath(href){
	if(href.indexOf("?")>-1){
		var index= href.indexOf("?");
		href = href.substring(0, index);
	}
	if(href.indexOf("#")>-1){
		var index= href.indexOf("#");
		href = href.substring(0, index);
	}
	return href.replace(new RegExp(domain, "i"), "");
}
/**
 * prototype extend method: get parent element by tagName
**/
Element.prototype.getParentElementByTag = function(tag) {
	if (!tag) return null;
	var element = null, parent = this;
	var popup = function() {
		parent = parent.parentElement;
		if (!parent) return null;
		var tagParent = parent.tagName.toLowerCase();
		if (tagParent === tag) {
			element = parent;
		} else if (tagParent == "body") {
			element = null;
		} else {
			popup();
		}
	};
	popup();
	return element;
};
readyDom(function(){
	initHref();
})
module.exports=goto;